
إليك شرح مفصل لكيفية عمل هذا الحدث عبر الطبقات المختلفة:

1. طبقة الأحداث (package events)
هذه الطبقة تحدد "شكل" البيانات التي تنتقل عبر النظام.

FileChunkPayload: يحتوي على المعلومات الأساسية للقطعة، وهي: معرف الملف الأصلي (FileID)، رقم ترتيب القطعة (ChunkIndex)، إجمالي عدد القطع المتوقعة لضمان عدم فقدان أي جزء (TotalChunks)، والبيانات الخام للقطعة نفسها (Data).

FileChunkEvent: يغلف البيانات السابقة ويضيف إليها طابعاً زمنياً (Timestamp) لتوثيق وقت وصولها.

2. طبقة المعالج (package handlers)
تعمل هذه الطبقة كمستقبل للحدث (غالباً من وسيط رسائل مثل RabbitMQ كما هو موضح في rabbit.go).

دالة Handle: وظيفتها هي استلام الحدث فور وصوله وتفكيك محتوياته. هي لا تقوم بأي معالجة منطقية، بل تكتفي بتمرير البيانات المستخرجة إلى طبقة الخدمات (Services) لتبدأ المعالجة الفعلية.

3. طبقة الخدمة (package services)
هنا يتم تنفيذ المنطق البرمجي والتعامل مع الملفات على القرص الصلب.

دالة OnChunkReceived:

عند استلام قطعة، تقوم بإنشاء مجلد مؤقت خاص بهذا الملف (FileID) إذا لم يكن موجوداً.

تقوم بحفظ محتوى القطعة في ملف مستقل يحمل رقمها (مثل part_0, part_1) داخل المجلد المؤقت.

تستدعي دالة الفحص لترى هل اكتمل النصاب.

دالة isComplete: تقارن عدد الملفات (القطع) الموجودة حالياً في المجلد المؤقت مع العدد الإجمالي المطلوب (TotalChunks).

دالة reassemble: بمجرد تحقق الاكتمال، تبدأ هذه الدالة بفتح ملف نهائي ودمج محتويات القطع بالترتيب التسلسلي الصحيح. بعد النجاح، تقوم بتنظيف المجلد المؤقت وحذف القطع لتوفير المساحة.

ملخص تدفق الحدث (Workflow):
الاستلام: يتم استقبال FileChunkEvent عبر rabbit.go.

التوجيه: يقوم الـ Handler بتمرير البيانات لمدير الخدمات.

التخزين: تقوم الخدمة بوضع القطعة في temp_chunks/FileID/part_X.

الاكتمال: إذا كان عدد القطع في المجلد يساوي TotalChunks:

يتم دمجهم في ملف واحد في مجلد uploads.

يتم استدعاء Cleanup لمسح القطع المؤقتة.