الخلاصة (دورة حياة الملف):server.go
1. دالة OnMessage(msg ChunkMessage)
هي "القلب النابض" للملف والنقطة التي تستقبل أي رسالة قادمة:

التحقق: تبدأ بالتأكد من أن الرسالة صالحة عبر ValidateMessage.

إذا كانت الرسالة جزءاً عادياً: تقوم بتخزين الجزء على القرص الصلب باستخدام StoreChunk.

إذا كانت الرسالة هي النهاية (IsEOF): 1. تقوم بتجميع كل الأجزاء في ملف واحد عبر AssembleFile. 2. ترسل الملف المكتمل للتحليل عبر ProcessFile. 3. تحذف الأجزاء المؤقتة لتوفير المساحة عبر Cleanup.

2. دالة ValidateMessage(msg ChunkMessage)
دالة أمنية بسيطة للتأكد من البيانات:

تتحقق من وجود FileID (معرف الملف).

تتأكد أن الرسالة ليست فارغة إلا إذا كانت مجرد إشارة لنهاية الملف (IsEOF).

3. دالة StoreChunk(msg ChunkMessage)
مسؤولة عن التخزين المؤقت:

تنشئ مجلداً خاصاً لكل ملف داخل مجلد temp_chunks باستخدام معرف الملف.

تحفظ كل قطعة في ملف مستقل يسمى part_X (حيث X هو رقم القطعة).

تستخدم نظام الملفات (القرص) بدلاً من الذاكرة العشوائية لتجنب استهلاك الرام في الملفات الضخمة.

4. دالة IsFileComplete(fileID string)
دالة فحص:

تتأكد ما إذا كان هناك أجزاء مخزنة بالفعل للملف المطلوب في المجلد المؤقت.

5. دالة AssembleFile(fileID string)
هي المسؤولة عن "إعادة البناء":

تنشئ ملفاً نهائياً بصيغة .pcap داخل مجلد uploads.

تبحث عن القطع بالترتيب (part_0, part_1, ...) وتدمج محتواها داخل الملف النهائي.

تتوقف فور عدم العثور على القطعة التالية في التسلسل.

المخرج: تعيد المسار الكامل للملف الذي تم تجميعه.

6. دالة ProcessFile(fileID string, filePath string)
جسر التواصل مع وحدة التحليل:

تأخذ مسار الملف المكتمل وترسله إلى حزمة (package) خارجية تسمى analysis لتنفيذ دالة AnalyzePCAP. هنا يتم فحص محتوى ملف الـ PCAP تقنياً.

7. دالة Cleanup(fileID string)
دالة التدبير المنزلي:

بعد انتهاء التجميع والتحليل، تقوم بحذف المجلد المؤقت الذي يحتوي على القطع الصغيرة (temp_chunks/fileID) لتنظيف السيرفر.
وصول قطع: StoreChunk تحفظها واحدة تلو الأخرى.

وصول إشارة النهاية: AssembleFile يجمعها في ملف .pcap واحد.

التحليل: ProcessFile يحلل الملف المكتمل.

التنظيف: Cleanup يمسح القطع التي لم نعد بحاجتها.
