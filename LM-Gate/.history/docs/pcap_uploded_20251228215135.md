package events

// PCAPAnalyzeEvent يمثل حدث طلب تحليل ملف PCAP
type PCAPAnalyzeEvent struct {
	FileID   string `json:"file_id"`
	FilePath string `json:"file_path"`
}

func (e PCAPAnalyzeEvent) Name() string {
	return "pcap.analyze"
}



package handlers

import (
	"LM-Gate/events"
	"LM-Gate/services"
)

type PCAPAnalyzeHandler struct {
	pcapService *services.PCAPService
}

func NewPCAPAnalyzeHandler(s *services.PCAPService) *PCAPAnalyzeHandler {
	return &PCAPAnalyzeHandler{pcapService: s}
}

func (h *PCAPAnalyzeHandler) Handle(event events.PCAPAnalyzeEvent) error {
	return h.pcapService.Analyze(event.FileID, event.FilePath)
}


package services

import (
	"fmt"

	"github.com/google/gopacket"
	"github.com/google/gopacket/pcap"
)

type PCAPService struct{}

func NewPCAPService() *PCAPService {
	return &PCAPService{}
}

// Analyze هو المنطق الحقيقي لتحليل الـ PCAP
func (s *PCAPService) Analyze(fileID string, filePath string) error {
	handle, err := pcap.OpenOffline(filePath)
	if err != nil {
		return fmt.Errorf("فشل فتح PCAP (%s): %w", fileID, err)
	}
	defer handle.Close()

	packetSource := gopacket.NewPacketSource(handle, handle.LinkType())

	count := 0
	for packet := range packetSource.Packets() {
		count++
		fmt.Printf("\n[PCAP:%s] Packet #%d\n", fileID, count)
		fmt.Println(packet.String())

		if count >= 2 {
			break
		}
	}

	return nil
}
