1. طبقة الأحداث (package events)
هنا يتم تعريف "الرسالة" التي يتم تداولها عبر النظام (مثل RabbitMQ):

FileChunkPayload: تحتوي على البيانات الخام للقطعة (Data)، ومعرف الملف الأصلي (FileID)، وترتيب هذه القطعة (ChunkIndex)، والعدد الكلي للقطع المتوقعة (TotalChunks).

FileChunkEvent: هو الغلاف الخارجي للرسالة ويحتوي على البيانات (Payload) وتوقيت الإرسال (Timestamp).

2. طبقة المعالج (package handlers)
هذه الطبقة تعمل كجسر استلام فقط:

NewFileChunkHandler: دالة تجهيز المعالج وربطه بمدير الخدمات.

Handle: بمجرد وصول قطعة ملف، تقوم هذه الدالة باستلام الحدث وتفكيكه، ثم تمرير كل معلومة (ID، ترتيب، إجمالي، بيانات) إلى طبقة الخدمات فوراً.

3. طبقة الخدمة (package services)
هنا يقع "العقل المدبر" للنظام وتتم العمليات الثقيلة:

NewManager: دالة البناء التي تحدد مسار المجلد المؤقت (temp_chunks) ومجلد التخزين النهائي (uploads).

OnChunkReceived:

تستقبل القطعة وتنشئ مجلداً خاصاً بالملف إذا لم يكن موجوداً.

تكتب محتوى القطعة في ملف مستقل على القرص بصيغة part_X.

تتحقق عبر دالة isComplete هل وصل عدد القطع للعدد الكلي المطلوب؟

إذا اكتملت القطع، تشغل عملية التجميع (reassemble) في الخلفية.

isComplete: دالة فحص تقارن عدد الملفات الموجودة في المجلد المؤقت مع العدد الإجمالي المتوقع.

reassemble:

تفتح ملفاً جديداً في مجلد التخزين النهائي.

تدمج جميع القطع بالترتيب الصحيح (0، 1، 2...) داخل الملف النهائي.

تقوم بمسح المجلد المؤقت (Cleanup) لتوفير المساحة.

ملخص الدوال في كل طبقة:
الطبقة	اسم الدالة	الوظيفة الأساسية
Events	FileChunkEvent	تعريف هيكل البيانات للقطعة
Handlers	Handle	استلام الحدث وتوجيهه للخدمة
Services	OnChunkReceived	حفظ القطعة على القرص والتحقق من الاكتمال
Services	isComplete	التأكد من وصول جميع القطع
Services	reassemble	دمج القطع في ملف واحد وتنظيف المؤقت